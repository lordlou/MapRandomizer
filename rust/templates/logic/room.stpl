<!DOCTYPE html>
<html lang="en-US">
<head>
<% include!("../common/header.stpl"); %>
<meta name="keywords" content="Super Metroid, Map Randomizer, Map Rando, Map, Randomizer">
<title>Logic - <%= room_name %></title>
</head>
<body>
<% include!("../common/navbar.stpl"); %>
<script>
document.getElementById("navigation-logic").classList.add("active");
</script>

<div class="container col-xl-10 col-xxl-8 pb-4">
    <h3 class="my-2"><%= room_name %></h3>
    <div class="row my-2">
        <div class="col-12 overflow-auto">
            <img src="/<%- room_diagram_path %>">
        </div>
    </div>

    <div class="row my-2">
        <div class="col-sm-6">
            <label for="fromNode">From node</label>
            <select id="fromNode" name="fromNode" class="form-select" onchange="updateSelect();">
            <option value="any" selected>Any</option>
            <% for (node_id, node_name) in &nodes { %>
                <option class="from-node-option" value="<%= node_id %>"><%= node_id %>: <%= node_name %></option>
            <% } %>
            </select>
        </div>
        <div class="col-sm-6">
            <label for="toNode">To node</label>
            <select id="toNode" name="toNode" class="form-select" onchange="updateSelect();">
            <option value="any" selected>Any</option>
            <% for (node_id, node_name) in &nodes { %>
                <option class="to-node-option" value="<%= node_id %>"><%= node_id %>: <%= node_name %></option>
            <% } %>
            </select>
        </div>
    </div>

    <h3 class="my-2">Strats</h3>
    <table class="table table-hover my-2">
    <tbody>
    <% for strat in strats { %>
    <tr class="strat-row" data-from-node="<%= strat.from_node_id %>" data-to-node="<%= strat.to_node_id %>">
    <td>
        <p>Name: <%= strat.name %><br>
        <% if strat.notable { %>
        Notable: true<br>
        <% } %>
        From <%= strat.from_node_id %>: <%= strat.from_node_name %><br>
        To <%= strat.to_node_id %>: <%= strat.to_node_name %><br>
        </p>
        <% if strat.note.len() > 0 { %> 
            <p><%= strat.note %></p>
        <% } %>
        <p class="mb-0">Requires:
        <% if strat.requires_json.lines().count() > 1 { %>
            <br><pre><%= strat.requires_json %></pre>
        <% } else { %>
            <tt><%= strat.requires_json %></tt>
        <% } %>
        </p>
    </td>
    </tr>
    <% } %>
    </tbody>
    </table>
</div>
<script>
function updateSelect() {
    var rows = document.getElementsByClassName("strat-row");
    var selectedFromNode = document.getElementById("fromNode").value;
    var selectedToNode = document.getElementById("toNode").value;
    var validFromSet = new Set();
    var validToSet = new Set();

    // Show/hide the matching set of Strats:
    for (var i = 0; i < rows.length; i++) {
        var row = rows.item(i);
        var rowFromNode = row.getAttribute("data-from-node");
        var rowToNode = row.getAttribute("data-to-node");
        var validFrom = (selectedFromNode == "any" || rowFromNode == selectedFromNode);
        var validTo = (selectedToNode == "any" || rowToNode == selectedToNode);
        if (validFrom && validTo) {
            row.classList.remove("d-none");
        } else {
            row.classList.add("d-none");
        }
        if (validFrom) {
            validToSet.add(rowToNode);
        }
        if (validTo) {
            validFromSet.add(rowFromNode);
        }
    }

    // Color the to/from node options by whether they have any matching strats:
    var fromOptions = document.getElementsByClassName("from-node-option");
    for (var i = 0; i < fromOptions.length; i++) {
        var opt = fromOptions.item(i);
        if (validFromSet.has(opt.value)) {
            opt.classList.remove("text-muted");
        } else {
            opt.classList.add("text-muted");
        }
    }

    var toOptions = document.getElementsByClassName("to-node-option");
    for (var i = 0; i < toOptions.length; i++) {
        var opt = toOptions.item(i);
        if (validToSet.has(opt.value)) {
            opt.classList.remove("text-muted");
        } else {
            opt.classList.add("text-muted");
        }
    }

}
</script>
</body>
</html>
